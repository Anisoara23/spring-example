<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
http://www.springframework.org/schema/util
http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="dbBankWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="sql" value="${bankInsertStatement}"/>
        <property name="dataSource" ref="dataSource"/>
        <property name="itemPreparedStatementSetter" ref="bankPreparedStatementSetter"/>
    </bean>

    <bean id="bankPreparedStatementSetter" class="org.example.batch.preparedstatement.BankPreparedStatementSetter"/>
    
    <bean id="compositeDbCustomerWriter" class="org.springframework.batch.item.support.CompositeItemWriter">
        <property name="delegates">
            <util:list id="dbWriters" value-type="org.springframework.batch.item.ItemWriter">
                <ref bean="dbCustomerWriter"/>
                <ref bean="dbCustomerInfoWriter"/>
            </util:list>
        </property>
    </bean>

    <bean id="dbCustomerWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="sql" value="${customerInsertStatement}"/>
        <property name="dataSource" ref="dataSource"/>
        <property name="itemPreparedStatementSetter" ref="customerPreparedStatementSetter"/>
    </bean>

    <bean id="customerPreparedStatementSetter" class="org.example.batch.preparedstatement.CustomerPreparedStatementSetter"/>

    <bean id="dbCustomerInfoWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="sql" value="${customerInfoInsertStatement}"/>
        <property name="dataSource" ref="dataSource"/>
        <property name="itemPreparedStatementSetter" ref="customerInfoPreparedStatementSetter"/>
    </bean>

    <bean id="customerInfoPreparedStatementSetter" class="org.example.batch.preparedstatement.CustomerInfoPreparedStatementSetter"/>

    <bean id="csvCustomerWriter" class="org.springframework.batch.item.file.FlatFileItemWriter">
        <property name="resource">
            <bean id="resource" class="org.springframework.core.io.FileSystemResource">
                <constructor-arg value="src/main/resources/data/output/customers.csv"/>
            </bean>
        </property>
        <property name="lineAggregator">
            <bean id="lineAggregator" class="org.springframework.batch.item.file.transform.DelimitedLineAggregator">
                <property name="delimiter" value=","/>
                <property name="fieldExtractor">
                    <bean id="fieldExtractor" class="org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor">
                        <property name="names">
                            <array value-type="java.lang.String">
                                <value>id</value>
                                <value>firstName</value>
                                <value>lastName</value>
                                <value>email</value>
                                <value>birthDate</value>
                                <value>idnp</value>
                                <value>phoneNumber</value>
                                <value>info.address.country</value>
                                <value>info.address.city</value>
                                <value>info.address.street</value>
                                <value>info.address.postalCode</value>
                                <value>info.citizenship</value>
                                <value>info.gender</value>
                                <value>info.occupation</value>
                            </array>
                        </property>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>
</beans>